{% extends 'hospital/base.html' %}

{% block title %}Consultations - {{ block.super }}{% endblock %}

{% block page_title %}Gestion des Consultations{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="section-title mb-3">Toutes les Consultations</h2>
            <div class="mb-4">
                <div class="row g-3">
                    <div class="col-md-8">
                        <div class="search-container position-relative">
                            <input type="text" class="form-control ps-5" placeholder="Rechercher une consultation..." id="searchInput" style="padding-left: 2.5rem;">
                            <i class="fas fa-search search-icon position-absolute" style="left: 12px; top: 50%; transform: translateY(-50%); z-index: 5; color: #6c757d;"></i>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-unified btn-primary w-100" hx-get="{% url 'consultation_create' %}" hx-target="#modal-container" hx-trigger="click" data-bs-toggle="modal" data-bs-target="#modal-container">
                            <i class="fas fa-plus me-2"></i>Nouvelle Consultation
                        </button>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <!-- Filtre par médecin -->
                        <select class="form-select" id="doctorFilter">
                            <option value="">Tous les médecins</option>
                            {% regroup consultations by doctor as doctor_groups %}
                            {% for doctor_group in doctor_groups %}
                                {% if doctor_group.grouper %}
                                    <option value="{{ doctor_group.grouper.id }}">{{ doctor_group.grouper.get_full_name|default:doctor_group.grouper.username }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <!-- Filtre par centre -->
                        <select class="form-select" id="centreFilter">
                            <option value="">Tous les centres</option>
                            {% regroup consultations by centre as centre_groups %}
                            {% for centre_group in centre_groups %}
                                {% if centre_group.grouper %}
                                    <option value="{{ centre_group.grouper.id }}">{{ centre_group.grouper.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <!-- Filtre par statut -->
                        <select class="form-select" id="statusFilter">
                            <option value="">Tous les statuts</option>
                            <option value="PENDING">En attente</option>
                            <option value="IN_PROGRESS">En cours</option>
                            <option value="COMPLETED">Terminée</option>
                            <option value="CANCELLED">Annulée</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="main-card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th style="min-width: 180px;">Patient</th>
                                    <th style="min-width: 120px;">Date</th>
                                    <th style="min-width: 150px;">Médecin</th>
                                    <th style="min-width: 120px;">Centre</th>
                                    <th style="min-width: 150px;">Motif</th>
                                    <th style="min-width: 150px;">Diagnostic</th>
                                    <th style="min-width: 80px;">Statut</th>
                                    <th style="min-width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="consultationsTableBody">
                                {% for consultation in consultations %}
                                <tr data-doctor="{{ consultation.doctor.id|default:'' }}" data-centre="{{ consultation.centre.id }}">
                                    <td class="fw-bold" style="font-size: 0.9rem;">
                                        <div class="d-flex flex-column">
                                            <div class="text-truncate" style="max-width: 180px;">
                                                <span class="text-uppercase">{{ consultation.patient.last_name }}</span>
                                                {% if consultation.patient.postname %} <span class="text-uppercase">{{ consultation.patient.postname }}</span>{% endif %}
                                                {{ consultation.patient.first_name }}
                                            </div>
                                            <small class="text-muted" style="font-size: 0.8rem;">#{{ consultation.patient.id }}</small>
                                        </div>
                                    </td>
                                    <td class="text-nowrap">{{ consultation.date|date:"d/m/Y H:i" }}</td>
                                    <td class="text-truncate" style="max-width: 120px;">{{ consultation.doctor.get_full_name|default:consultation.doctor.username }}</td>
                                    <td class="text-truncate" style="max-width: 100px;">{{ consultation.centre.name }}</td>
                                    <td class="text-truncate" style="max-width: 120px;">{{ consultation.reason|default:"Non renseigné" }}</td>
                                    <td class="text-truncate" style="max-width: 120px;">{{ consultation.diagnosis|default:"Non renseigné" }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if consultation.status == 'PENDING' %}bg-warning
                                            {% elif consultation.status == 'IN_PROGRESS' %}bg-info
                                            {% elif consultation.status == 'COMPLETED' %}bg-success
                                            {% elif consultation.status == 'CANCELLED' %}bg-secondary
                                            {% endif %}">
                                            {% if consultation.status == 'PENDING' %}En attente
                                            {% elif consultation.status == 'IN_PROGRESS' %}En cours
                                            {% elif consultation.status == 'COMPLETED' %}Terminée
                                            {% elif consultation.status == 'CANCELLED' %}Annulée
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            <a href="{% url 'consultation_detail' consultation.id %}" class="btn btn-unified btn-sm btn-outline-primary" title="Voir le détail">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button class="btn btn-unified btn-sm btn-outline-secondary" hx-get="{% url 'consultation_edit' consultation.id %}" hx-target="#modal-container" hx-trigger="click" data-bs-toggle="modal" data-bs-target="#modal-container" title="Éditer">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-unified btn-sm btn-outline-danger" hx-get="{% url 'consultation_delete' consultation.id %}" hx-target="#modal-container" hx-trigger="click" data-bs-toggle="modal" data-bs-target="#modal-container" title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <a href="{% url 'patient_detail' consultation.patient.id %}" class="btn btn-unified btn-sm btn-outline-info" title="Voir la fiche patient">
                                                <i class="fas fa-user-injured"></i>
                                            </a>
                                            <a href="{% url 'print_document' consultation.patient.id 'prescription' %}" class="btn btn-unified btn-sm btn-outline-success" title="Imprimer l'ordonnance">
                                                <i class="fas fa-print"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-5">
                                        <i class="fas fa-stethoscope fa-3x mb-3"></i>
                                        <h5>Aucune consultation trouvée</h5>
                                        <p>Commencez par planifier votre première consultation</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Container -->
<div class="modal fade" id="modal-container" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="modal-content">
            <!-- Content will be loaded here by HTMX -->
        </div>
    </div>
</div>

<script>
    // Fonction de filtrage des consultations
    function filterConsultations() {
        const searchValue = document.getElementById('searchInput').value.toLowerCase();
        const doctorValue = document.getElementById('doctorFilter').value;
        const centreValue = document.getElementById('centreFilter').value;
        const statusValue = document.getElementById('statusFilter').value;
        
        const tableRows = document.querySelectorAll('#consultationsTableBody tr');
        
        tableRows.forEach(function(row) {
            const rowText = row.textContent.toLowerCase();
            const rowDoctor = row.getAttribute('data-doctor');
            const rowCentre = row.getAttribute('data-centre');
            const rowStatus = row.querySelector('td:nth-child(7) span').textContent.trim();
            
            let showRow = true;
            
            // Filtrer par recherche textuelle
            if (searchValue && !rowText.includes(searchValue)) {
                showRow = false;
            }
            
            // Filtrer par médecin
            if (doctorValue && rowDoctor !== doctorValue) {
                showRow = false;
            }
            
            // Filtrer par centre
            if (centreValue && rowCentre !== centreValue) {
                showRow = false;
            }
            
            // Filtrer par statut
            if (statusValue && rowStatus !== getStatusText(statusValue)) {
                showRow = false;
            }
            
            if (showRow) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    // Fonction pour convertir les valeurs de statut en texte affiché
    function getStatusText(statusValue) {
        switch(statusValue) {
            case 'PENDING':
                return 'En attente';
            case 'IN_PROGRESS':
                return 'En cours';
            case 'COMPLETED':
                return 'Terminée';
            case 'CANCELLED':
                return 'Annulée';
            default:
                return '';
        }
    }
    
    // Ajouter des écouteurs d'événements pour chaque filtre
    document.getElementById('searchInput').addEventListener('input', filterConsultations);
    document.getElementById('doctorFilter').addEventListener('change', filterConsultations);
    document.getElementById('centreFilter').addEventListener('change', filterConsultations);
    document.getElementById('statusFilter').addEventListener('change', filterConsultations);
</script>

<!-- Pagination -->
{% if consultations.has_other_pages %}
<div class="row mt-4">
    <div class="col-12">
        <nav aria-label="Pagination des consultations">
            <ul class="pagination justify-content-center">
                {% if consultations.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1" aria-label="Première">
                            <span aria-hidden="true">&laquo;&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ consultations.previous_page_number }}" aria-label="Précédente">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">&laquo;&laquo;</span>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link">&laquo;</span>
                    </li>
                {% endif %}

                {% for num in consultations.paginator.page_range %}
                    {% if consultations.number == num %}
                        <li class="page-item active" aria-current="page">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > consultations.number|add:'-3' and num < consultations.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if consultations.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ consultations.next_page_number }}" aria-label="Suivante">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ consultations.paginator.num_pages }}" aria-label="Dernière">
                            <span aria-hidden="true">&raquo;&raquo;</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">&raquo;</span>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link">&raquo;&raquo;</span>
                    </li>
                {% endif %}
            </ul>
        </nav>
        <div class="text-center text-muted">
            Page {{ consultations.number }} sur {{ consultations.paginator.num_pages }} 
            ({{ consultations.paginator.count }} consultations au total)
        </div>
    </div>
</div>
{% endif %}
{% endblock %}